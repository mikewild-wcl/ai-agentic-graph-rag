#!meta

{"kernelInfo":{"defaultKernelName":"csharp","items":[{"name":"csharp","languageName":"csharp"},{"name":"fsharp","languageName":"F#","aliases":["f#","fs"]},{"name":"html","languageName":"HTML"},{"name":"http","languageName":"HTTP"},{"name":"javascript","languageName":"JavaScript","aliases":["js"]},{"name":"mermaid","languageName":"Mermaid"},{"name":"pwsh","languageName":"PowerShell","aliases":["powershell"]},{"name":"value"}]}}

#!markdown

# Load movies into Neo4j

Requires a running Neo4j instance

Movies cypher file taken from https://github.com/neo4j-graph-examples/movies/blob/main/scripts/movies.cypher

#!pwsh

# Copy the cypher file into the Docker container (assumes Docker is running and the container is named 'neo4j-agentic-graphrag')
docker cp "..\cypher\movies-graphrag-book-download.cypher" neo4j-agentic-graphrag:/import

#!csharp

#r "nuget:Microsoft.Extensions.Configuration, *-*"
#r "nuget:Microsoft.Extensions.Configuration.Json, *-*"
#r "nuget:Neo4j.Driver, *-*"
#r "nuget:System.Net.Http, *-*"

using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Configuration.Json;
using Neo4j.Driver;
using System.IO;

#!csharp

const string DB_NAME = "neo4j"; // Default database name in Neo4j
var _clearGraphDB = false; // Set to true to clear the graph database before loading data

//Get configuration
var config = new ConfigurationBuilder()
    .AddJsonFile(Path.Combine(Directory.GetCurrentDirectory(), "appsettings.json"))
    .AddJsonFile(Path.Combine(Directory.GetCurrentDirectory(), "appsettings.Development.json"), optional: true)
    .Build();

var user = config["Neo4j:User"];
var password = config["Neo4j:Password"];
var connectionUri = config["Neo4j:Connection"];

$"Neo4j details: Connection: {connectionUri}; auth user: {user}/{password}"

#!csharp

// Create driver
var driver = GraphDatabase.Driver(connectionUri, AuthTokens.Basic(user, password));
await driver.VerifyConnectivityAsync();
Console.WriteLine("Connection established.");

#!csharp

try
{
    var cypherFilePath = "/import/movies-graphrag-book-download.cypher";

    using (var session = driver.AsyncSession())
    {
        if (_clearGraphDB)
        {
            await session.ExecuteWriteAsync(async tx =>
            {
                // Delete all nodes and relationships.
                // See https://stackoverflow.com/questions/22357379/neo4j-how-to-drop-all-constraints
                await tx.RunAsync("MATCH (n) DETACH DELETE n");
                Console.WriteLine("Deleted all nodes.");
            });

            await session.ExecuteWriteAsync(async tx =>
            {
                Console.WriteLine("Deleting indexes.");
                await tx.RunAsync("CALL apoc.schema.assert({},{},true) YIELD label, key RETURN *");
                Console.WriteLine("Deleted all indexes and constraints.");
            });
        }
        
        await session.ExecuteWriteAsync(async tx =>
        {
            Console.WriteLine("running commands.");
            //await tx.RunAsync(@"CALL apoc.cypher.runFile('C:\dev_mike\sk-graph-rag\cypher\zzmovies-graphrag-book original.cypher');");
            await tx.RunAsync($"CALL apoc.cypher.runFile('{cypherFilePath}');");
            Console.WriteLine("Ran commands from cypher file.");
        });

        await session.ExecuteWriteAsync(async tx =>
        {
            Console.WriteLine("Adding index.");
            await tx.RunAsync("CREATE INDEX FOR (m:Movie) ON (m.released)");
        });
        Console.WriteLine("Created indexes.");
    }
}
catch (Exception ex)
{
    Console.WriteLine($"Error during query execution: {ex.Message}");
}

#!csharp

// Cleanup
await driver.DisposeAsync();
